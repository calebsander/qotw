<html>
	<head>
		<STANDARD_INCLUDES />
		<title>Vote</title>
		<script>
			var QUOTE = /".+"\s+-/;
			var MULTIPLE_QUOTES = /[A-Za-z\d\s]+:\s.+\n?/;
			function paragraphContainsQuote(paragraph) {
				return QUOTE.test(paragraph) || MULTIPLE_QUOTES.test(paragraph);
			}
			$(document).ready(function() {
				var voteTable = $('table#votes>tbody');
				$.ajax({
					'url': '/api/lastmessage',
					'dataType': 'json',
					'success': function(response) {
						$('div#message-title').text('Voting on "' + response.title + '"');
						var paragraphs = response.body.split(/(?:<br>){2,}/);
						for (var i = 0, paragraph, id; i < paragraphs.length; i++) {
							paragraph = paragraphs[i];
							if (paragraphContainsQuote(paragraph)) {
								id = 'quote' + String(i);
								voteTable.append(
									$('<tr>').addClass('quote').append(
										$('<td>').addClass('center').append(
											$('<label>').addClass('radio').append(
												$('<input>').attr('type', 'radio').attr('name', 'vote-radio').attr('data-toggle', 'radio')
											)
										)
									).append(
										$('<td>').addClass('quote-text').html(paragraph)
									)
								);
							}
						}
						$('input:radio').radiocheck();
					}
				});
				function submit() {
					var selectedRadio = $('input:radio:checked').eq(0);
					if (!selectedRadio.length) {
						alert('No quote selected.');
						return;
					}
					$('button#submit').removeClass('btn-success').addClass('btn-warning');
					$.ajax({
						'url': '/api/vote',
						'type': 'POST',
						'data': JSON.stringify({
							'quote': selectedRadio.closest('tr').children('td.quote-text').text(),
							'token': params.token
						}),
						'dataType': 'json',
						'success': function(response) {
							if (response.success) {
								$('button#submit').removeClass('btn-warning').addClass('btn-success');
								alert('Success!');
								window.location.assign('/');
							}
							else {
								$('button#submit').removeClass('btn-warning').addClass('btn-danger');
								setTimeout(function() {
									$('button#submit').removeClass('btn-danger').addClass('btn-default');
								}, 1000);
								alert(response.message + '\nMake sure you used the link from the most recent e-mail. Note that you can only vote once.');
							}
						},
						'error': function() {
							$('button#submit').removeClass('btn-warning').addClass('btn-danger');
							setTimeout(function() {
								$('button#submit').removeClass('btn-danger').addClass('btn-default');
							}, 1000);
						}
					});
				}
				$('button#submit').click(submit);
			});
		</script>
	</head>
	<body>
		<STANDARD_NAVBAR />
		<div id = 'body'>
			<div id = 'vote-row'>
				<div class = 'col-md-12'>
					<div class = 'panel panel-default'>
						<div class = 'panel-heading' id = 'message-title'>Vote</div>
						<div class = 'panel-body'>
							<table class = 'table' id = 'votes'>
								<thead>
									<tr>
										<th>Votes</th><th>Quote</th>
									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
							<button class = 'btn btn-success' id = 'submit'>Submit</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>